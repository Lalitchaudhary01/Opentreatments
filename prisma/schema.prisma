generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Patient {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Basic Personal Info
  fullName    String?
  age         Int?
  gender      String?
  phoneNumber String?
  email       String?
  address     String?

  // Physical Data
  height     String?
  weight     String?
  bloodGroup String?

  // Medical History
  conditions    String[] // known diseases
  allergies     String[]
  medications   Json?
  pastSurgeries String[]
  familyHistory String[] // diabetes, BP, thyroid, etc.

  // Lifestyle (Full Body Checkup Essentials)
  smokingStatus      String? // smoker / non-smoker / past smoker
  alcoholConsumption String? // none / occasional / regular
  dietType           String? // veg / non-veg / vegan
  sleepHours         Int? // avg daily sleep
  activityLevel      String? // low / moderate / high
  waterIntake        Int? // glasses/day
  stressLevel        String? // low / moderate / high

  // Checkup & Doctor Visit
  healthScore     Int?
  lastVisit       DateTime?
  nextAppointment DateTime?
  primaryDoctor   String?

  // System Fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id                       String                    @id @default(cuid())
  name                     String?
  email                    String                    @unique
  password                 String?
  createdAt                DateTime                  @default(now())
  role                     Role                      @default(USER)
  isVerified               Boolean                   @default(false)
  otp                      String?
  otpExpiry                DateTime?
  phone                    String?                   @unique
  accounts                 Account[]
  AdminAction              AdminAction[]
  blogs                    Blog[]
  claims                   Claim[]
  comments                 Comment[]
  Hospital                 Hospital?
  independentConsultations IndependentConsultation[]
  IndependentDoctor        IndependentDoctor?
  IndependentReview        IndependentReview[]
  InsuranceCompany         InsuranceCompany?
  likes                    Like[]
  Notification             Notification[]
  Orders                   Order[]
  Pharmacy                 Pharmacy?
  policies                 Policy[]
  sessions                 Session[]
  LabCompany               LabCompany?
  labBookings              LabBooking[]
  patientProfile           Patient?
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  access_token      String?
  refresh_token     String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id])

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id])
}

model Blog {
  id        String    @id @default(cuid())
  title     String
  content   String
  authorId  String
  image     String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  author    User      @relation(fields: [authorId], references: [id])
  tags      BlogTag[]
  comments  Comment[]
  likes     Like[]
}

model Comment {
  id        String   @id @default(cuid())
  content   String
  blogId    String
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  blog      Blog     @relation(fields: [blogId], references: [id])
  author    User     @relation(fields: [userId], references: [id])
}

model Like {
  id        String   @id @default(cuid())
  blogId    String
  userId    String
  createdAt DateTime @default(now())
  blog      Blog     @relation(fields: [blogId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([blogId, userId])
}

model Tag {
  id    String    @id @default(cuid())
  name  String    @unique
  blogs BlogTag[]
}

model BlogTag {
  blogId String
  tagId  String
  blog   Blog   @relation(fields: [blogId], references: [id], onDelete: Cascade)
  tag    Tag    @relation(fields: [tagId], references: [id])

  @@id([blogId, tagId])
}

model Hospital {
  id         String         @id @default(cuid())
  name       String
  slug       String         @unique
  address    String?
  city       String?
  state      String?
  country    String?
  phone      String?
  email      String?
  website    String?
  logo       String?
  image      String?
  verified   Boolean        @default(false)
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
  status     HospitalStatus @default(PENDING)
  userId     String         @unique
  doctors    Doctor[]
  estimates  Estimate[]
  facilities Facility[]
  user       User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  Insurance  Insurance[]
  procedures Procedure[]
  services   Service[]
}

model Service {
  id          String   @id @default(cuid())
  name        String
  cost        Float?
  description String?
  hospitalId  String
  hospital    Hospital @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
}

model Facility {
  id          String   @id @default(cuid())
  name        String
  description String?
  hospitalId  String
  hospital    Hospital @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
}

model Insurance {
  id         String   @id @default(cuid())
  name       String
  provider   String?
  cashless   Boolean  @default(false)
  hospitalId String
  hospital   Hospital @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
}

model Doctor {
  id             String   @id @default(cuid())
  name           String
  specialization String
  experience     Int?
  profilePic     String?
  hospitalId     String
  hospital       Hospital @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
}

model Procedure {
  id          String     @id @default(cuid())
  name        String
  description String?
  cost        Float?
  duration    String?
  hospitalId  String
  estimates   Estimate[]
  hospital    Hospital   @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
}

model Policy {
  id           String     @id @default(cuid())
  userId       String
  name         String
  provider     String?
  policyNumber String?
  sumInsured   Float
  deductible   Float      @default(0)
  coPay        Float      @default(0)
  startDate    DateTime
  endDate      DateTime
  cashless     Boolean    @default(false)
  pdfUrl       String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  estimates    Estimate[]
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Estimate {
  id            String    @id @default(cuid())
  policyId      String
  hospitalId    String
  procedureId   String
  procedureCost Float
  coveredAmount Float
  outOfPocket   Float
  createdAt     DateTime  @default(now())
  hospital      Hospital  @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  policy        Policy    @relation(fields: [policyId], references: [id], onDelete: Cascade)
  procedure     Procedure @relation(fields: [procedureId], references: [id], onDelete: Cascade)
}

model Pharmacy {
  id            String         @id @default(cuid())
  name          String
  address       String?
  city          String?
  state         String?
  phone         String
  latitude      Float?
  longitude     Float?
  country       String?
  createdAt     DateTime       @default(now())
  email         String
  gstNumber     String?
  licenseNumber String
  ownerName     String
  status        PharmacyStatus @default(PENDING)
  updatedAt     DateTime       @updatedAt
  userId        String         @unique
  InventoryLog  InventoryLog[]
  medicines     Medicine[]
  orders        Order[]
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  stock         StockEntry[]   @relation("PharmacyStock")
}

model Medicine {
  id            String         @id @default(cuid())
  name          String
  genericName   String?
  strength      String?
  price         Float
  description   String?
  pharmacyId    String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  brand         String?
  category      String?
  dosageForm    String?
  gst           Float?
  manufacturer  String?
  mrp           Float?
  inventoryLogs InventoryLog[]
  pharmacy      Pharmacy       @relation(fields: [pharmacyId], references: [id])
  orderItems    OrderItem[]
  priceTrends   PriceTrend[]
  stock         StockEntry[]
  substitutes   Substitute[]   @relation("OriginalMedicine")
  substituteFor Substitute[]   @relation("SubstituteMedicine")
}

model StockEntry {
  id            String         @id @default(cuid())
  medicineId    String
  batchNumber   String
  quantity      Int
  expiryDate    DateTime
  purchasePrice Float?
  sellingPrice  Float?
  type          StockType      @default(INCOMING)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  pharmacyId    String
  logs          InventoryLog[]
  medicine      Medicine       @relation(fields: [medicineId], references: [id])
  pharmacy      Pharmacy       @relation("PharmacyStock", fields: [pharmacyId], references: [id])
}

model InventoryLog {
  id              String              @id @default(cuid())
  stockEntryId    String
  medicineId      String
  pharmacyId      String
  changeType      InventoryChangeType
  quantityChanged Int
  note            String?
  createdAt       DateTime            @default(now())
  medicine        Medicine            @relation(fields: [medicineId], references: [id])
  pharmacy        Pharmacy            @relation(fields: [pharmacyId], references: [id])
  stockEntry      StockEntry          @relation(fields: [stockEntryId], references: [id])
}

model Order {
  id         String      @id @default(cuid())
  userId     String
  pharmacyId String
  status     OrderStatus @default(PENDING)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  pharmacy   Pharmacy    @relation(fields: [pharmacyId], references: [id])
  user       User        @relation(fields: [userId], references: [id])
  items      OrderItem[]
}

model OrderItem {
  id         String   @id @default(cuid())
  orderId    String
  medicineId String
  quantity   Int
  price      Float
  medicine   Medicine @relation(fields: [medicineId], references: [id])
  order      Order    @relation(fields: [orderId], references: [id])
}

model PriceTrend {
  id         String   @id @default(cuid())
  medicineId String
  price      Float
  date       DateTime @default(now())
  medicine   Medicine @relation(fields: [medicineId], references: [id])
}

model Substitute {
  id                   String   @id @default(cuid())
  medicineId           String
  substituteMedicineId String
  medicine             Medicine @relation("OriginalMedicine", fields: [medicineId], references: [id])
  substitute           Medicine @relation("SubstituteMedicine", fields: [substituteMedicineId], references: [id])
}

model IndependentDoctor {
  id                String                    @id @default(cuid())
  userId            String                    @unique
  name              String
  specialties       String[]
  specialization    String
  experience        Int?
  gender            String?
  profilePic        String?
  fees              Float?
  rating            Float                     @default(0)
  totalReviews      Int                       @default(0)
  languages         String[]
  availability      Json?
  badges            String[]
  city              String?
  status            DoctorStatus              @default(PENDING)
  createdAt         DateTime                  @default(now())
  updatedAt         DateTime                  @updatedAt
  consultations     IndependentConsultation[]
  user              User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  IndependentReview IndependentReview[]
}

model IndependentConsultation {
  id                String             @id @default(cuid())
  doctorId          String
  userId            String
  slot              DateTime
  duration          Int?
  status            ConsultationStatus @default(PENDING)
  mode              String             @default("online")
  fee               Float?
  paymentId         String?
  paymentStatus     String             @default("unpaid")
  notes             String?
  prescription      String?
  cancelReason      String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  doctor            IndependentDoctor  @relation(fields: [doctorId], references: [id])
  user              User               @relation(fields: [userId], references: [id])
  IndependentReview IndependentReview?
  Payment           Payment?
}

model IndependentReview {
  id             String                  @id @default(cuid())
  consultationId String                  @unique
  doctorId       String
  userId         String
  rating         Int
  feedback       String?
  createdAt      DateTime                @default(now())
  consultation   IndependentConsultation @relation(fields: [consultationId], references: [id], onDelete: Cascade)
  doctor         IndependentDoctor       @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  user           User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  message   String
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Payment {
  id             String                  @id @default(cuid())
  consultationId String                  @unique
  amount         Float
  status         PaymentStatus           @default(PENDING)
  provider       String?
  transactionId  String?
  createdAt      DateTime                @default(now())
  consultation   IndependentConsultation @relation(fields: [consultationId], references: [id], onDelete: Cascade)
}

model AdminAction {
  id         String   @id @default(cuid())
  adminId    String
  actionType String
  targetId   String
  targetType String
  details    String?
  createdAt  DateTime @default(now())
  admin      User     @relation(fields: [adminId], references: [id], onDelete: Cascade)
}

model InsuranceCompany {
  id                 String          @id @default(cuid())
  userId             String          @unique
  name               String
  email              String          @unique
  contactPhone       String?
  registrationNumber String?
  logoUrl            String?
  description        String?
  provider           String?
  profile            Json?
  address            String?
  website            String?
  status             InsuranceStatus @default(PENDING)
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  claims             Claim[]
  user               User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  plans              Plan[]
}

model Plan {
  id              String           @id @default(cuid())
  companyId       String
  name            String
  description     String?
  coverageDetails Json
  premium         Float
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  coverageAmount  Float
  claims          Claim[]
  company         InsuranceCompany @relation(fields: [companyId], references: [id], onDelete: Cascade)
}

model Claim {
  id          String           @id @default(cuid())
  userId      String
  companyId   String
  planId      String
  billDetails Json
  status      ClaimStatus      @default(PENDING)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  company     InsuranceCompany @relation(fields: [companyId], references: [id], onDelete: Cascade)
  plan        Plan             @relation(fields: [planId], references: [id], onDelete: Cascade)
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum Role {
  USER
  ADMIN
  DOCTOR
  HOSPITAL
  PHARMACY
  INSURANCE_COMPANY
}

enum HospitalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PharmacyStatus {
  PENDING
  APPROVED
  REJECTED
}

enum StockType {
  INCOMING
  OUTGOING
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PACKED
  DELIVERED
  CANCELLED
}

enum InventoryChangeType {
  SALE
  DAMAGE
  EXPIRE
  MANUAL_ADJUSTMENT
}

enum DoctorStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ConsultationStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
  CANCELLED
}

enum NotificationType {
  CONSULTATION_REQUEST
  CONSULTATION_STATUS
  ADMIN_APPROVAL
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

enum InsuranceStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ClaimStatus {
  PENDING
  APPROVED
  REJECTED
}

model LabCompany {
  id                 String       @id @default(cuid())
  userId             String       @unique
  user               User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  name               String
  registrationNumber String?
  email              String       @unique
  phone              String?      @unique
  address            String
  city               String?
  website            String?
  documents          String[]
  status             LabStatus    @default(PENDING)
  tests              LabTest[]
  packages           LabPackage[]
  slots              LabSlot[]
  bookings           LabBooking[]
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
}

model LabTest {
  id              String           @id @default(cuid())
  labId           String
  lab             LabCompany       @relation(fields: [labId], references: [id], onDelete: Cascade)
  name            String
  code            String? // keep optional if needed
  price           Int
  sampleType      String?
  method          String?
  tatHours        Int?
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  labPackageTests LabPackageTest[]

  @@unique([labId, code]) // <= per-lab uniqueness
  @@index([labId]) // perf
}

model LabPackage {
  id          String     @id @default(cuid())
  labId       String
  lab         LabCompany @relation(fields: [labId], references: [id], onDelete: Cascade)
  name        String
  description String?
  price       Int
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  packageTests LabPackageTest[]
}

model LabPackageTest {
  packageId String
  testId    String
  pkg       LabPackage @relation(fields: [packageId], references: [id], onDelete: Cascade)
  test      LabTest    @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@id([packageId, testId])
  @@index([testId])
}

model LabSlot {
  id        String     @id @default(cuid())
  labId     String
  lab       LabCompany @relation(fields: [labId], references: [id], onDelete: Cascade)
  dayOfWeek Int
  startTime String
  endTime   String
  capacity  Int        @default(10)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@index([labId])
}

model LabBooking {
  id          String        @id @default(cuid())
  labId       String
  lab         LabCompany    @relation(fields: [labId], references: [id], onDelete: Cascade)
  userId      String
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        String
  itemId      String
  appointment DateTime
  status      BookingStatus @default(PENDING)
  notes       String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([labId])
  @@index([userId])
}

enum LabStatus {
  PENDING
  APPROVED
  REJECTED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}
